<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thu ti·ªÅn ƒëi·ªán</title>
  <!-- SheetJS ƒë·ªÉ ƒë·ªçc file Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Th∆∞ vi·ªán qu√©t QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f0f0;
      max-width: 100vw;
      min-height: 100vh;
      padding: 0;
      border-radius: 0;
      font-size: 17px;
    }
    .container {
      max-width: 430px;
      margin: auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 16px #bbb8;
      padding: 18px 6px 24px 6px;
      min-height: 100vh;
    }
    input, button, textarea {
      font-size: 17px;
      margin: 7px 0;
      padding: 10px 8px;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    input:focus, textarea:focus {
      border: 1.5px solid #4387fd;
      outline: none;
    }
    button {
      background: #4387fd;
      color: white;
      border: none;
      font-weight: bold;
      margin-left: 5px;
      margin-right: 0;
      min-width: 46px;
      min-height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 8px #bbb4;
    }
    button:active { background: #3066b2; }
    h2 { margin-bottom: 16px; text-align: center; }

    .row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .label {
      width: 120px;
      min-width: 90px;
      flex-shrink: 0;
    }
    #maKH, #tenKH, #soTien, #nguoiThuTien {
      flex: 1;
      min-width: 0;
      background: #f8f8f8;
    }

    #hoaDon {
      width: 100%;
      min-height: 180px;
      border: 2px solid black;
      border-radius: 13px;
      padding: 14px 7px;
      white-space: pre-wrap;
      font-size: 17px;
      font-family: 'Times New Roman', serif;
      margin-bottom: 12px;
      background: #faf9f7;
      box-shadow: 0 2px 8px #eee;
    }
    #hoaDon p { margin: 0; }

    .action-btns {
      display: flex;
      gap: 10px;
      flex-direction: row;
      margin-bottom: 18px;
      justify-content: center;
    }
    .history-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    #lichSuIn, #lichSuThu {
      width: 100%;
      min-height: 72px;
      resize: vertical;
    }
    .history-btns {
      display: flex;
      gap: 7px;
      margin-bottom: 10px;
      justify-content: flex-end;
    }
    #qr-reader {
      width: 98vw !important;
      max-width: 360px;
      margin: 12px auto;
      display: none;
      border-radius: 18px;
      box-shadow: 0 4px 24px #ccc;
      background: #fafafa;
      overflow: hidden;
    }
    /* ·∫®n n√∫t khi in */
    @media print {
      body * { visibility: hidden; }
      #hoaDon, #hoaDon * { visibility: visible; }
      #hoaDon { position: absolute; top: 0; left: 0; width: 100%; }
    }
  </style>
</head>
<body style="background: #f0f0f0;">
<div class="container">
  <h2>Thu ti·ªÅn ƒëi·ªán</h2>
  <!-- ƒê·∫®Y D·ªÆ LI·ªÜU EXCEL -->
  <div class="row" style="justify-content:center;">
    <button type="button" onclick="document.getElementById('fileInput').click()">ƒê·∫©y d·ªØ li·ªáu</button>
    <!--
      Th√™m MIME types ƒë·ªÉ ƒë·∫£m b·∫£o Android cho ph√©p ch·ªçn file Excel,
      tr√°nh tr∆∞·ªùng h·ª£p ch·ªâ hi·ªán camera/h√¨nh ·∫£nh.
    -->
    <input type="file"
           id="fileInput"
           style="display:none"
           accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
           onchange="docFileExcel(event)"/>
  </div>
  <div class="row">
    <label class="label">Ng∆∞·ªùi thu ti·ªÅn</label>
    <input id="nguoiThuTien" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu"/>
  </div>
  <div class="row">
    <label class="label">M√£ kh√°ch h√†ng</label>
    <input id="maKH" list="danhSachKH" placeholder="(m·ª•c t√¨m ki·∫øm)" onkeydown="if(event.key==='Enter'){timKiemMaKH()}">
    <datalist id="danhSachKH"></datalist>
    <button type="button" onclick="timKiemMaKH()">üîç</button>
    <button type="button" onclick="batDauQuetQR()">üì∑</button>
  </div>
  <div id="qr-reader"></div>
  <div class="row">
    <label class="label">S·ªë ti·ªÅn</label>
    <input id="soTien" readonly />
  </div>
  <div class="row">
    <label class="label">T√™n KH</label>
    <input id="tenKH" readonly />
  </div>
  <div id="hoaDon">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
  <div class="action-btns">
    <button type="button" onclick="inHoaDon()">In</button>
    <button type="button" style="border:2px solid black;" onclick="xacNhanThu()">X√°c nh·∫≠n ƒë√£ thu</button>
  </div>
  <div class="history-area">
    <label>L·ªãch s·ª≠ in</label>
    <textarea id="lichSuIn" readonly></textarea>
    <label><b>L·ªãch s·ª≠ thu</b></label>
    <textarea id="lichSuThu" readonly></textarea>
    <div class="history-btns">
      <button type="button" onclick="xuatLichSu('in')">Xu·∫•t l·ªãch s·ª≠ in</button>
      <button type="button" onclick="xuatLichSu('thu')">Xu·∫•t l·ªãch s·ª≠ thu</button>
      <button type="button" onclick="xuatLichSuExcel()">Xu·∫•t Excel</button>
      <button type="button" onclick="xoaLichSu()">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
    </div>
  </div>
</div>
<script>
let duLieu = [];
let lichSuIn = JSON.parse(localStorage.getItem("lichSuIn")) || [];
let lichSuThu = JSON.parse(localStorage.getItem("lichSuThu")) || [];

function formatVND(number) {
  return Number(number).toLocaleString('vi-VN') + ' ‚Ç´';
}

function timKiemMaKH() {
  const maKH = document.getElementById("maKH").value.trim();
  const kh = duLieu.find(row => row.MA_KHTT === maKH);
  if (kh) {
    document.getElementById("tenKH").value = kh.TEN_KHTT;
    document.getElementById("soTien").value = kh.TONG_NOP;
    hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, kh.TONG_NOP);
  } else {
    document.getElementById("hoaDon").innerText = "[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]";
  }
}

function hienThiHoaDon(maKH, tenKH, soTien) {
  const nguoiThu = document.getElementById("nguoiThuTien").value || "-";
  const phi = 2000;
  const tong = Number(soTien) + phi;
  const now = new Date();
  const ngay = now.toLocaleDateString('vi-VN');
  const gio = now.toTimeString().split(' ')[0];
  const thoiGian = `Ng√†y ${ngay}, Gi·ªù ${gio}`;
  const noiDung = `
    <div style="text-align:center; font-weight:bold;">BI√äN LAI NH·∫¨N TI·ªÄN CHUY·ªÇN KHO·∫¢N</div>
    <p>M√£ KH: ${maKH}</p>
    <p>T√™n KH: ${tenKH}</p>
    <p>S·ªë Ti·ªÅn: ${formatVND(soTien)}</p>
    <p>Ph√≠: ${formatVND(phi)}</p>
    <p>T·ªïng Ti·ªÅn: ${formatVND(tong)}</p>
    <p>Ng∆∞·ªùi thu ti·ªÅn: ${nguoiThu}</p>
    <div style="text-align:center; font-weight:bold;">ƒê√É NH·∫¨N TI·ªÄN</div>
    <p>${thoiGian}</p>
  `;
  document.getElementById("hoaDon").innerHTML = noiDung;
}

function inHoaDon() {
  const maKH = document.getElementById("maKH").value;
  const tenKH = document.getElementById("tenKH").value;
  const soTien = Number(document.getElementById("soTien").value || 0);
  hienThiHoaDon(maKH, tenKH, soTien);
  lichSuIn.push({ maKH, tenKH, soTien: soTien + 2000, thoiGian: new Date().toLocaleDateString('vi-VN') });
  localStorage.setItem("lichSuIn", JSON.stringify(lichSuIn));
  capNhatLichSu();
  setTimeout(() => { window.print(); }, 0);
}

function xacNhanThu() {
  const maKH = document.getElementById("maKH").value;
  const tenKH = document.getElementById("tenKH").value;
  const soTien = Number(document.getElementById("soTien").value || 0) + 2000;
  const thoiGian = new Date().toLocaleString();
  lichSuThu.push({ maKH, tenKH, soTien, thoiGian });
  localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));
  capNhatLichSu();
}

function capNhatLichSu() {
  const inText = lichSuIn.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  const thuText = lichSuThu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  document.getElementById("lichSuIn").value = inText;
  document.getElementById("lichSuThu").value = thuText;
}

function xuatLichSu(loai) {
  const duLieu = loai === 'in' ? lichSuIn : lichSuThu;
  const text = duLieu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${item.soTien}`).join("\n");
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `lich_su_${loai}.txt`;
  a.click();
}

function xuatLichSuExcel() {
  const ws = XLSX.utils.json_to_sheet([
    ...lichSuIn.map(e => ({ ...e, Lo·∫°i: 'In' })),
    ...lichSuThu.map(e => ({ ...e, Lo·∫°i: 'Thu' }))
  ]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "L·ªãch S·ª≠");
  XLSX.writeFile(wb, "lich_su.xlsx");
}

function docFileExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    duLieu = XLSX.utils.sheet_to_json(sheet);
    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(row => {
      const option = document.createElement("option");
      option.value = row.MA_KHTT;
      dataList.appendChild(option);
    });
  };
  reader.readAsArrayBuffer(file);
}

function xoaLichSu() {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ kh√¥ng?")) {
    localStorage.removeItem("lichSuIn");
    localStorage.removeItem("lichSuThu");
    lichSuIn = [];
    lichSuThu = [];
    capNhatLichSu();
  }
}

// QR CODE FUNCTIONS
let html5QrCode; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ qu·∫£n l√Ω camera

function batDauQuetQR() {
  const qrRegion = document.getElementById('qr-reader');
  qrRegion.style.display = 'block';
  if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrCodeMessage => {
      document.getElementById('maKH').value = qrCodeMessage;
      qrRegion.style.display = 'none';
      html5QrCode.stop();
      timKiemMaKH();
    },
    errorMessage => { /* kh√¥ng l√†m g√¨ khi l·ªói */ }
  ).catch(err => {
    alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera ho·∫∑c thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£!");
    qrRegion.style.display = 'none';
  });
}

window.onload = capNhatLichSu;
</script>
</body>
</html>
